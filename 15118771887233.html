<!DOCTYPE html>
<html>

<head>
    <title>
         原来在计算机里，确定性的计算，也那么难 - LoveAria 
    </title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="OvO 随便写点东西~">

    <link rel="stylesheet" type="text/css" href="asset/yue.css">
    <link rel="stylesheet" type="text/css" href="asset/main.css">
    <link rel="stylesheet" type="text/css" href="asset/tomorrow.css">

    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="LoveAria">

    <script src="asset/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>

<body>
    <header class="yue site-header">
        <div class="wrapper">
            <a class="site-title" href="index.html">LoveAria</a>
            <nav class="site-nav">
                <a href="#" class="menu-icon">
                    
                    <svg viewBox="0 0 18 15">
                        <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"
                        />
                        <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"
                        />
                        <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"
                        />
                    </svg>

                </a>
                <div class="trigger">
                    
                        <a class="page-link" href="index.html">Home</a>
                    
                        <a class="page-link" href="archives.html">Archives</a>
                    
                        <a class="page-link" href="http://github.com/bramblex">Github</a>
                    
                </div>
            </nav>
        </div>
    </header>
</body>

</html> <div class="page-content yue">
    <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
            <header class="post-header">
                <h1 class="post-title" itemprop="name headline">原来在计算机里，确定性的计算，也那么难</h1>
                <div class="post-description">
                    
                        <p>最近我们在做一个 2D 多人对战游戏，为了节省流量带宽以及提高实时性，我们选择了用帧同步，并且只同步一帧中每个玩家的输入，让后由服务器、哥哥玩家手机分别计算。</p>

<p>同一套 c艹 代码写出来的引擎，同样的输入，又没有随机数，最后结果肯定是一毛一样的对不对？肯定是一样的吧？然而事与愿违，结果就是同一局游戏，大家一开都一样，但是玩着玩着大家就变成各玩各的了，每一个玩家看到的都是自己队友和对手都在疯狂旋转跳跃闭着眼，怼墙怼家怼队友。大家从一局游戏变成了各玩各的。很显然，问题出现了，出现在了本应该运算出一样结果的代码，为什么算着算着就不一样了？</p>

<h2 id="toc_0">坑爹的浮点数</h2>

<p>系统学过计算机知识的小伙伴，二进制和十进制在整数上互相转换是不会改变值的，这也意味着在计算机里面用二进制来存储十进制的数将会是准确无误的。但是小数呢？</p>

<p>在十进制 0.1 、 0.01 、 0.001 这些小数是什么意义呢？他们代表的是 十分之一 、 百分之一 、 千分之一。十进制的小数部分是由 \( \frac{1}{10^n} \) 的和组成的。同样的，那二进制的小数表示的则是 \( \frac{1}{2^n} \) 的和组成的数。这两种小数并没有办法做到一一对应，比如常见的 \( \frac{3}{10} \) 也就是 \( 0.3 \) 就没有办法很好的用有限位二进制数准确存储，也就诞生了 \( 0.3 - 0.1 \neq 0.2 \) 这种经典的坑。我们把用二进制存储十进制小数而丢失原来的精度称之为失精度。</p>

<p>失精度其实不可怕，可怕的是在不同的cpu、系统、编译器、甚至编译参数下，丢失的精度是不一样的。而我的处理方式是直接舍去一部分精度，将所有的数值转化成整型。</p>

<h2 id="toc_1">坑爹的弧度和三角函数</h2>

<p>圆是这个世界上最完美的图形了，然而隐藏在圆背后的 \( \pi \) 却真的让计算机爱不起来。我们前面刚说，有限位的二进制无法准确存储十进制的小数，那 \( \pi \) 这个东西连有限位的十进制都没办精确表示的无理数、超越数，更何况是二进制了。伴随着 \( \pi \) 而生的弧度也是个大坑。比如横平竖直的 \( \angle 90^\circ \) 都要表示成一个 \( \frac{\pi}{2} \) 这么一个东西，真是让人爱不起来。</p>

<p>我的解决方案是以 360° 作为角度计量，并且预先计算并且固定统一的三角函数表。</p>

<h2 id="toc_2">指针的的顺序</h2>

<p>在实际开发中，很多时候户需要用在 set 里面插入指针，或者把指针当成 map 的 key 来使用。但是这时候就会出现问题， set 和 key 都是有序的，指针默认会当成 size_t 类型来进行排序。但是问题是指针这个地址值使我们在程序里面不可控的，所以在遍历的时的顺序产生一些不一致。</p>

<p>我的解决方法是手动实现指针的比较算法，并且以指针指向对象的 id 进行排序，这样所有的 set / map 都能保证一致的遍历顺序。</p>

<h2 id="toc_3">后记</h2>

<p>通过努力，现在新的东西碰撞和运算已经在 arm / intel 下进行复杂的测试最终表现出一致的结果了。哎，采坑经历又丰富了。</p>

                    
                </div>
                <p class="post-meta">
                    <time class="post-time" datetime="2017-11-28T21:53:08+08:00"itemprop="datePublished">Created by Tisoga at 2017/11/28</time>
                </p>
            </header>
            <div class="post-content" itemprop="articleBody">
                <p>最近我们在做一个 2D 多人对战游戏，为了节省流量带宽以及提高实时性，我们选择了用帧同步，并且只同步一帧中每个玩家的输入，让后由服务器、哥哥玩家手机分别计算。</p>

<p>同一套 c艹 代码写出来的引擎，同样的输入，又没有随机数，最后结果肯定是一毛一样的对不对？肯定是一样的吧？然而事与愿违，结果就是同一局游戏，大家一开都一样，但是玩着玩着大家就变成各玩各的了，每一个玩家看到的都是自己队友和对手都在疯狂旋转跳跃闭着眼，怼墙怼家怼队友。大家从一局游戏变成了各玩各的。很显然，问题出现了，出现在了本应该运算出一样结果的代码，为什么算着算着就不一样了？</p>

<h2 id="toc_0">坑爹的浮点数</h2>

<p>系统学过计算机知识的小伙伴，二进制和十进制在整数上互相转换是不会改变值的，这也意味着在计算机里面用二进制来存储十进制的数将会是准确无误的。但是小数呢？</p>

<p>在十进制 0.1 、 0.01 、 0.001 这些小数是什么意义呢？他们代表的是 十分之一 、 百分之一 、 千分之一。十进制的小数部分是由 \( \frac{1}{10^n} \) 的和组成的。同样的，那二进制的小数表示的则是 \( \frac{1}{2^n} \) 的和组成的数。这两种小数并没有办法做到一一对应，比如常见的 \( \frac{3}{10} \) 也就是 \( 0.3 \) 就没有办法很好的用有限位二进制数准确存储，也就诞生了 \( 0.3 - 0.1 \neq 0.2 \) 这种经典的坑。我们把用二进制存储十进制小数而丢失原来的精度称之为失精度。</p>

<p>失精度其实不可怕，可怕的是在不同的cpu、系统、编译器、甚至编译参数下，丢失的精度是不一样的。而我的处理方式是直接舍去一部分精度，将所有的数值转化成整型。</p>

<h2 id="toc_1">坑爹的弧度和三角函数</h2>

<p>圆是这个世界上最完美的图形了，然而隐藏在圆背后的 \( \pi \) 却真的让计算机爱不起来。我们前面刚说，有限位的二进制无法准确存储十进制的小数，那 \( \pi \) 这个东西连有限位的十进制都没办精确表示的无理数、超越数，更何况是二进制了。伴随着 \( \pi \) 而生的弧度也是个大坑。比如横平竖直的 \( \angle 90^\circ \) 都要表示成一个 \( \frac{\pi}{2} \) 这么一个东西，真是让人爱不起来。</p>

<p>我的解决方案是以 360° 作为角度计量，并且预先计算并且固定统一的三角函数表。</p>

<h2 id="toc_2">指针的的顺序</h2>

<p>在实际开发中，很多时候户需要用在 set 里面插入指针，或者把指针当成 map 的 key 来使用。但是这时候就会出现问题， set 和 key 都是有序的，指针默认会当成 size_t 类型来进行排序。但是问题是指针这个地址值使我们在程序里面不可控的，所以在遍历的时的顺序产生一些不一致。</p>

<p>我的解决方法是手动实现指针的比较算法，并且以指针指向对象的 id 进行排序，这样所有的 set / map 都能保证一致的遍历顺序。</p>

<h2 id="toc_3">后记</h2>

<p>通过努力，现在新的东西碰撞和运算已经在 arm / intel 下进行复杂的测试最终表现出一致的结果了。哎，采坑经历又丰富了。</p>

            </div>
            <div>
                <div id="container"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
  owner: 'bramblex',
  repo: 'blog',
  oauth: {
    client_id: 'de3185bbebb2aa60e192',
    client_secret: '3d981f46c2b3c4b6a9334097408bb033d1e9dd59',
  },
})
gitment.render('container')
</script>
                
                
            </div>
        </article>
    </div>
</div>  <footer id="footer" class="yue">
    <div class="wrapper">
        <p>Designed and Written by <a href="https://twitter.com/Tisoga">Tisoga</a></p>
    </div>
</footer>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>
